{% extends "base.html" %}
{% block title %}Two Week Preview{% endblock %}
{% block content %}

<h2 class="text-center mb-4">Two Week Preview</h2>

<div class="text-center mb-3">
  <label for="majorGroupFilterDropdown" class="form-label">Filter by Major Group:</label>
  <div class="dropdown d-inline-block">
    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="majorGroupFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
      Select Major Groups
    </button>
    <form class="dropdown-menu p-3" aria-labelledby="majorGroupFilterDropdown" id="majorGroupFilterForm">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" value="Civil and Construction" id="majorCivil" name="major_group"
          {% if 'Civil and Construction' in major_groups %}checked{% endif %}>
        <label class="form-check-label" for="majorCivil">Civil and Construction</label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" value="Mathematics" id="majorMath" name="major_group"
          {% if 'Mathematics' in major_groups %}checked{% endif %}>
        <label class="form-check-label" for="majorMath">Mathematics</label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" value="Engineering" id="majorEng" name="major_group"
          {% if 'Engineering' in major_groups %}checked{% endif %}>
        <label class="form-check-label" for="majorEng">Engineering</label>
      </div>
      <!-- Add more checkboxes as needed -->
      <button type="button" class="btn btn-primary btn-sm mt-2" onclick="applyFilter()">Apply</button>
    </form>
  </div>
</div>

<script>
  function applyFilter() {
    const checkboxes = document.querySelectorAll('#majorGroupFilterForm input[name="major_group"]:checked');
    const selected = Array.from(checkboxes).map(cb => cb.value);
    const url = new URL(window.location);

    if (selected.length > 0) {
      url.searchParams.set('major_group', selected.join(','));
    } else {
      url.searchParams.delete('major_group');
    }

    window.location = url.toString();
  }
</script>

<script>
  function onFilterChange() {
    const select = document.getElementById('majorGroupFilter');
    const selected = Array.from(select.selectedOptions).map(o => o.value);
    const url = new URL(window.location);
    if (selected.length > 0) {
      url.searchParams.set('major_group', selected.join(','));
    } else {
      url.searchParams.delete('major_group');
    }
    window.location = url.toString();
  }
</script>

<style>
  .week-box {
      max-width: 1000px;
      margin: 1.5rem auto;
      padding: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      background: #fefefe;
    }
  .week-box-sad {
      max-width: 1000px;
      margin: 1.5rem auto;
      padding: 1rem;
      border: 1px solid #7e7e7e;
      border-radius: 6px;
      background: #c9e2ff;
    }
    .week-box h3, .week-box-sad h3 {
      margin-top: 0;
      border-bottom: 1px solid #ddd;
      padding-bottom: 0.5rem;
    }
    .week-box-sad h3 {
      border-color: #7e7e7e;
    }
    .event-row {
    display: grid;
    grid-template-columns: 1fr 1.5fr 3fr 2fr 2fr;
    /* Columns: Weekday/Date | Type | Company | Time | Location */
    gap: 10px;
    padding: 6px 0;
    border-bottom: 1px solid #eee;
    align-items: center;
    white-space: nowrap;
  }
  .event-row:last-child {
    border-bottom: none;
  }
  .event-cell {
    overflow: visible;
    text-overflow: clip;
    white-space: nowrap;
  }
  .event-cell.company {
    display: flex;
    align-items: center;
  }

  /* Color coding for major groups */
  .event-color-marker {
    width: 12px;
    height: 12px;
    display: inline-block;
    margin-right: 6px;
    border-radius: 2px;
    flex-shrink: 0;
  }
  .color-Civil_and_Construction { background-color: #ffd700; }  /* gold */
  .color-Mathematics { background-color: #1e90ff; }            /* dodger blue */
  .color-Engineering { background-color: #32cd32; }            /* lime green */
</style>

{% set major_group_colors = {
  "Civil and Construction": "color-Civil_and_Construction",
  "Mathematics": "color-Mathematics",
  "Engineering": "color-Engineering"
} %}

<h2 class="text-center mb-3">
  {% if major_groups %}
    {{ major_groups }} Events
  {% else %}
    All Events
  {% endif %}
</h2>

<div class="week-box-sad">
  <h3>This Week</h3>
  {% for event in events %}
    {% set event_date = event.EventDate | todatetime %}
    {% if event_date >= days[0] and event_date <= days[4] %}
      <div class="event-row">
        <div class="event-cell date">{{ event_date.strftime('%a, %b %d') }}</div>
        <div class="event-cell">
          {% set company_name = event.Company or event.EmployerName or '' %}
          {% if 'Fair' in company_name %}
            Fair
          {% elif 'Tabling' in company_name %}
            Tabling
          {% else %}
            Info Session
          {% endif %}
        </div>
        <div class="event-cell company">
          {% set groups = event.MajorGroup.split(',') if event.MajorGroup else [] %}
          {% set color_class = '' %}
          {% for g in groups %}
            {% set g_trim = g.strip() %}
            {% if g_trim in major_group_colors %}
              {% set color_class = major_group_colors[g_trim] %}
            {% endif %}
          {% endfor %}
          <span class="event-color-marker {{ color_class }}"></span>
          <strong>{{ event.Company or event.EmployerName or '' }}</strong>
        </div>
        <div class="event-cell">{{ event | format_time_range }}</div>
        <div class="event-cell">{{ event.Location or event.Building ~ ' ' ~ event.Room }}</div>
      </div>
    {% endif %}
  {% endfor %}
</div>

<div class="week-box">
  <h3>Next Week</h3>
  {% for event in events %}
    {% set event_date = event.EventDate | todatetime %}
    {% if event_date >= days[5] and event_date <= days[9] %}
      <div class="event-row">
        <div class="event-cell date">{{ event_date.strftime('%a, %b %d') }}</div>
        <div class="event-cell">
          {% set company_name = event.Company or event.EmployerName or '' %}
          {% if 'Fair' in company_name %}
            Fair
          {% elif 'Tabling' in company_name %}
            Tabling
          {% else %}
            Info Session
          {% endif %}
        </div>
        <div class="event-cell company">
          {% set groups = event.MajorGroup.split(',') if event.MajorGroup else [] %}
          {% set color_class = '' %}
          {% for g in groups %}
            {% set g_trim = g.strip() %}
            {% if g_trim in major_group_colors %}
              {% set color_class = major_group_colors[g_trim] %}
            {% endif %}
          {% endfor %}
          <span class="event-color-marker {{ color_class }}"></span>
          <strong>{{ event.Company or event.EmployerName or '' }}</strong>
        </div>
        <div class="event-cell">{{ event | format_time_range }}</div>
        <div class="event-cell">{{ event.Location or event.Building ~ ' ' ~ event.Room }}</div>
      </div>
    {% endif %}
  {% endfor %}
</div>

{% endblock %}
